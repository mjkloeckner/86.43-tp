import{V as m,i as At,j as It,e as yt,f as xt,E as vt,T as we,R as B,L as ve,C as G,I as nt,M as S,k as rt,l as Dt,h as W,m as Gt,F as Ge,g as kt,n as Mt,b as A,c as j,B as D,d as at,P as le,S as Et,W as zt,O as Rt,A as Bt,H as Ut,D as Vt,o as _t,p as Ht,G as Nt,a as Wt,q as st,r as Xt,s as $t,t as Ee,u as Zt,v as Ot}from"./OrbitControls-5nYykTM8.js";import{e as Pt,v as qt,f as Kt}from"./elevation_map2-Co2iZauO.js";import{t as Yt}from"./tree_forbidden_zone_map-PTOsYFl3.js";import{t as Qe,r as Je,p as et}from"./pasto-JkRKC7jR.js";import{d as jt,P as _e}from"./durmientes-DdlZvmqy.js";import{m as ge}from"./BufferGeometryUtils-CB7ch46w.js";import{t as Qt,l as Jt}from"./pared-de-ladrillos-BbDjYEBo.js";import{m as eo}from"./madera-BY2TwKea.js";const de=new It(0,0,0,"YXZ"),me=new m,to={type:"change"},oo={type:"lock"},no={type:"unlock"},it=Math.PI/2;class ro extends At{constructor(t,o){super(),this.camera=t,this.domElement=o,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=ao.bind(this),this._onPointerlockChange=so.bind(this),this._onPointerlockError=io.bind(this),this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return this.camera}getDirection(t){return t.set(0,0,-1).applyQuaternion(this.camera.quaternion)}moveForward(t){const o=this.camera;me.setFromMatrixColumn(o.matrix,0),me.crossVectors(o.up,me),o.position.addScaledVector(me,t)}moveRight(t){const o=this.camera;me.setFromMatrixColumn(o.matrix,0),o.position.addScaledVector(me,t)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function ao(e){if(this.isLocked===!1)return;const t=e.movementX||e.mozMovementX||e.webkitMovementX||0,o=e.movementY||e.mozMovementY||e.webkitMovementY||0,r=this.camera;de.setFromQuaternion(r.quaternion),de.y-=t*.002*this.pointerSpeed,de.x-=o*.002*this.pointerSpeed,de.x=Math.max(it-this.maxPolarAngle,Math.min(it-this.minPolarAngle,de.x)),r.quaternion.setFromEuler(de),this.dispatchEvent(to)}function so(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(oo),this.isLocked=!0):(this.dispatchEvent(no),this.isLocked=!1)}function io(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}function lo(e=20,t=14,o=.5,r=26){const n=new yt;n.moveTo(-t/2,0),n.lineTo(-t/2,e*1/3),n.moveTo(-t/2,e*1/3),n.quadraticCurveTo(0,e,t/2,e*1/3),n.moveTo(t/2,0),n.lineTo(t/2,0),n.lineTo(t/2-o,0),n.moveTo(t/2-o,0),n.lineTo(t/2-o,e*1/3),n.moveTo(t/2-o,e*1/3),n.quadraticCurveTo(0,e-o*2,-t/2+o,e*1/3),n.lineTo(-t/2+o,0),n.moveTo(-t/2+o,0),n.lineTo(-t/2,0),n.moveTo(-t/2,0);const a=n.getPoints(),i=new xt(a),c={curveSegments:24,steps:50,depth:r},l=new vt(i,c);return l.translate(1,0,-r/2),l}let He,Ne;const xe={elevationMap:{url:Pt,object:null},treeForbiddenMap:{url:Yt,object:null}},tt=100,ot=100,co=10,mo=-1;function uo(e,t){let o=t*4,r=e.data;return[r[o],r[o+1],r[o+2],r[o+3]]}function Ct(e,t,o){return uo(e,o*e.width+t)}function lt(e){const t=Math.floor(e.x),o=e.y,r=Math.floor(e.z);if(o>6.8||o<3.25)return!0;let n=Ct(He,t,r);const a=n[0],i=n[1],c=n[2];return a<=10&&i>=250&&c<=10||a<=80&&i<=80&&c<=80||a>=200&&i>=200&&c>=200}function ct(e=0){const t=Math.floor(Math.random()*(tt-e*2)),o=Math.floor(Math.random()*(ot-e*2)),n=Ct(Ne,t,o)[0]/255*co;return new m(t+e,n,o+e)}function po(e){console.log("Generating `"+e+"` instances of tree");let t=3;const o=new G(.1,.25,t,40,40);o.translate(0,t/2,0);const r=new nt;r.copy(o);const n=new S({color:8142592}),a=new rt(r,n,e),i=1.25,c=new Dt(i,40,40),l=new nt;l.copy(c);const d=new S({color:3561513}),s=new rt(l,d,e);new W;const f=new W,P=new W,M=new W,C=3;for(let p=0;p<e;p++){let k=ct(C);for(let E=0;lt(k)&&(k=ct(C),E++!=1e3);++E);if(lt(k))continue;const g=-1.5;k.x-=(tt+C+1.5)/2,k.y+=mo+g,k.z-=(ot+C)/2,f.makeTranslation(k),P.identity(),M.identity();let b=.6+Math.random()*(t/3);P.makeScale(1,b,1),P.premultiply(f),k.y+=b*t,f.makeTranslation(k),M.premultiply(f),a.setMatrixAt(p,P),s.setMatrixAt(p,M)}return console.log("Done generating `"+e+"` instances of tree"),[a,s]}function fo(){console.log("Loading maps data");let e=document.createElement("canvas"),t=e.getContext("2d"),o=xe.treeForbiddenMap.object.image,r=xe.elevationMap.object.image;const n=tt,a=ot;e.width=n,e.height=a,t.drawImage(o,0,0,n,a),He=t.getImageData(0,0,n,a),He.data,t.drawImage(r,0,0,n,a),Ne=t.getImageData(0,0,n,a),Ne.data,console.log("All maps data loaded succesfully")}function ho(e,t){t.wrapS=t.wrapT=B,xe[e].object=t,console.log("Texture `"+e+"` loaded")}function wo(e){const t=new ve;t.onLoad=()=>{console.log("All textures loaded"),e()};for(const o in xe){console.log("Loading textures");const r=new we(t),n=xe[o];n.object=r.load(n.url,ho.bind(this,o),null,a=>{console.error(a)})}}wo(fo);const We={tierra:{url:Qe,object:null},roca:{url:Je,object:null},pasto:{url:et,object:null},elevationMap:{url:Pt,object:null}};function go(e,t,o,r,n,a){console.log("Generating terrain geometry");let i=new Gt;const c=[],l=[],d=[],s=[];let f=document.createElement("canvas"),P=f.getContext("2d"),M=a.image;f.width=r,f.height=n,P.drawImage(M,0,0,r,n);let p=P.getImageData(0,0,r,n).data;const k=r-1;for(let g=0;g<r-1;g++)for(let b=0;b<n-1;b++){let E,z,X,U,H=p[(g+b*r)*4]/255;E=g>0?p[(g-1+b*r)*4]/255:void 0,z=g<r-1?z=p[(g+1+b*r)*4]/255:void 0,X=b>0?p[(g+(b-1)*r)*4]/255:void 0,U=b<n-1?p[(g+(b+1)*r)*4]/255:void 0;let $;E==null?$=z-H:U==null?$=E-H:$=(z-E)/2;let R;X==null?R=U-H:U==null?R=X-H:R=(U-X)/2;const ne=o*H;c.push(e*g/r-e/2),c.push(ne),c.push(t*b/n-t/2);let ce=new m(e/r,$*o,0).normalize(),N=new m(0,R*o,t/n).normalize(),Z=new m;Z.crossVectors(N,ce),d.push(Z.x),d.push(Z.y),d.push(Z.z),s.push(g/(r-1)),s.push(b/(n-1)),!(g==r-2||b==n-2)&&(l.push(g+b*k),l.push(g+1+b*k),l.push(g+1+(b+1)*k),l.push(g+b*k),l.push(g+1+(b+1)*k),l.push(g+(b+1)*k))}return i.setAttribute("position",new Ge(c,3)),i.setAttribute("normal",new Ge(d,3)),i.setAttribute("uv",new Ge(s,2)),i.setIndex(l),i}function bo(e,t){t.wrapS=t.wrapT=B,We[e].object=t,console.log("Texture `"+e+"` loaded")}function yo(e){const t=new ve;t.onLoad=()=>{console.log("All textures loaded")};for(const o in We){console.log("Loading textures");const r=new we(t),n=We[o];n.object=r.load(n.url,bo.bind(this,o),null,a=>{console.error(a)})}}yo();let te;const xo=new kt([new m(-2,0,0),new m(-1,0,.5),new m(0,0,.55),new m(1,0,.5),new m(2,0,0)],!1),Xe={tierra:{url:Qe,object:null},roca:{url:Je,object:null},pasto:{url:et,object:null},durmientes:{url:jt,object:null}};function $e(e){return te==null&&console.log("railsPath is undefined"),[te.getPointAt(e),te.getTangentAt(e)]}function vo(e,t,o){const r=new W,n=new W,a=new W;let i=te.getPointAt(t),c=xo.getPointAt(e);c.multiplyScalar(.5),c.x*=1.25;let l=new m,d=new m,s=new m;l=te.getTangent(t),l.normalize(),d=new m(0,1,0),s.crossVectors(l,d),n.makeTranslation(i),r.identity(),a.identity(),a.makeTranslation(i),r.makeBasis(s,l,d),a.multiply(r),c.applyMatrix4(a);const f=c.x,P=c.y,M=c.z;o.set(f,P,M)}function ko(){return new _e(vo,250,250)}function dt(e=.5,t){return function(r,n,a){const i=new W,c=new W,l=new W;new m;let d=te.getPointAt(n),s=new m(Math.cos(r*6.28)+t.x,t.y,Math.sin(r*6.28)+t.z);s.multiplyScalar(.1*e);let f=new m,P=new m,M=new m;f=te.getTangentAt(n),P=new m(0,1,0),M.crossVectors(f,P),c.makeTranslation(d),i.identity(),l.identity(),l.makeTranslation(d),i.makeBasis(M,f,P),l.multiply(i),s.applyMatrix4(l);const C=s.x,p=s.y,k=s.z;a.set(C,p,k)}}function Mo(e=.35){let t=[];const o=dt(e,new m(9.5,0,e+8)),r=dt(e,new m(-9.5,0,e+8)),n=new _e(o,100,500),a=new _e(r,100,500);return t.push(n),t.push(a),ge(t)}function Po(e,t){t.wrapS=t.wrapT=B,Xe[e].object=t,console.log("Texture `"+e+"` loaded")}function jo(e){const t=new ve;t.onLoad=()=>{console.log("All textures loaded"),e()};for(const o in Xe){console.log("Loading textures");const r=new we(t),n=Xe[o];n.object=r.load(n.url,Po.bind(this,o),null,a=>{console.error(a)})}}function Co(){te=new kt([new m(0,0,32),new m(28,0,32),new m(28,0,0),new m(5,0,-37),new m(-35,0,-30),new m(-10,0,0)],!0,"catmullrom",.75)}jo(Co);const q=10,u=2.5,mt=u+.375,se=2.5,De=5,_=6,O=3,v=.375,fe=1.475,ut=2.5,Y=.425,ze=1.245,ye=-.45,ke=4,Lo=10,pt=.6,Ze=.25;let Oe,qe;function Fo(){return console.log("Building train cabin roof"),new D(6,v,6)}function So(){console.log("Building train cabin");let e=[];const t=new D(u*2,v,_);t.translate(0,De/2,-_/2),e.push(t);const o=new D(u*2,v,_);o.rotateZ(Math.PI/2),o.translate(u-v/2,v/2,-_/2),e.push(o);const r=new D(u*2,v,_);r.rotateZ(Math.PI/2),r.translate(-u+v/2,v/2,-_/2),e.push(r);const n=new D(v,v,O);n.rotateZ(Math.PI/2),n.translate(-u+v/2,-u+v,-_-O/2),e.push(n);const a=new D(v,v,O);a.rotateZ(Math.PI/2),a.translate(u-v/2,u,-_-O/2),e.push(a);const i=new D(v,v,O);i.rotateZ(Math.PI/2),i.translate(u-v/2,-u+v,-_-O/2),e.push(i);const c=new D(v,v,O);c.rotateZ(Math.PI/2),c.translate(-u+v/2,u,-_-O/2),e.push(c);const l=ge(e);return l.rotateX(Math.PI/2),l}function To(){let e=[];const t=new G(u,u,q,32);e.push(t);const o=new G(mt,mt,se,32);o.translate(0,q/2+se/2,0),e.push(o);const r=new D(u*2,q+se+De,1);r.translate(0,-se/2,u),e.push(r);const n=4,a=new G(.55,.55,n,32);a.translate(0,-(u+n/2)+1,-(q+se)/2),a.rotateX(Math.PI/2),e.push(a);const i=ge(e);return i.rotateX(Math.PI/2),i.translate(0,u+.25,0),i}function ue(){const e=new G(fe,fe,Y);e.rotateZ(Math.PI/2),new G(fe,fe,Y).rotateZ(Math.PI/2);const o=new S({color:3750201,side:A,shininess:100});return new j(e,o)}function Re(e){const t=new G(.325,.325,5);t.rotateZ(Math.PI/2);const o=new S({color:8028032,side:A,shininess:100});return new j(t,o)}function Ao(){return new D(3.5,2.5,q+se+De)}function Io(){console.log("Building train");const e=new Mt,t=Ao(),o=new S({color:8028032,side:A,shininess:100}),r=new j(t,o);e.add(r);const n=To(),a=new S({color:16390665,side:A,shininess:100}),i=new j(n,a);r.add(i),i.position.set(0,(ut+v)/2,ze);const c=So(),l=new j(c,a);r.add(l),l.position.set(0,(ut+v)/2,-q+De/2+ze);const d=Fo(),s=new S({color:16510032,side:A,shininess:100}),f=new j(d,s);l.add(f),f.position.set(0,_+O+v/2,0);const P=Re();r.add(P);const M=Re();r.add(M);const C=Re();r.add(C),P.position.set(0,ye,-.6),M.position.set(0,ye,-.6+fe*2.5),C.position.set(0,ye,-.6-fe*2.5);const p=new G(1.25,1.5,ke);p.rotateX(Math.PI/2),p.translate(u-.25,-.25,q-ke/1.5);const k=new G(1.25,1.5,ke);k.rotateX(Math.PI/2),k.translate(-u+.25,-.25,q-ke/1.5);const g=ge([k,p]),b=new S({color:3750201,side:A,shininess:100});r.add(new j(g,b)),r.position.set(0,-2,-2.75);const E=ue();E.position.set(u-Y/2.1,0,0),P.add(E);const z=ue();z.position.set(-u+Y/2.1,0,0),P.add(z);const X=ue();X.position.set(u-Y/2.1,0,0),M.add(X);const U=ue();U.position.set(-u+Y/2.1,0),M.add(U);const H=ue();H.position.set(u-Y/2.1,0,0),C.add(H);const $=ue();$.position.set(-u+Y/2.1,0,0),C.add($);const R=new D(Ze,.5,Lo);qe=new j(R,o),Oe=new j(R,o),r.add(Oe),r.add(qe),Lt();const ne=1.1,ce=new G(ne,ne,1,32);ce.rotateX(Math.PI/2);const N=new S({color:3750201,side:A,shininess:100,emissive:16175917}),Z=new j(ce,N);return e.add(Z),Z.position.set(0,u+ze-ne/2-.3,(q+se)/2-.3),e.position.set(0,2,0),e}function Lt(e=0){Oe.position.set(-u-Ze/2,ye+1*Math.sin(e*Math.PI/2),pt-1*Math.cos(e*Math.PI/2)),qe.position.set(u+Ze/2,ye+1*Math.sin(e*Math.PI/2),pt-1*Math.cos(e*Math.PI/2))}const I={tierra:{url:Qt,object:null},ladrillos:{url:Jt,object:null}};function Do(e,t){t.wrapS=t.wrapT=B,I[e].object=t,console.log("Texture `"+e+"` loaded")}function Go(e){const t=new ve;t.onLoad=()=>{console.log("All textures loaded")};for(const o in I){console.log("Loading textures");const r=new we(t),n=I[o];n.object=r.load(n.url,Do.bind(this,o),null,a=>{console.error(a)})}}const Ft=.25,Ce=2.5,be=10,Me=.65;function ft(e=2,t=3,o=1,r=0,n=10){const a=t*2,i=n,c=n,l=e*(o+a)+o+i+c,d=r+t+Ft,s=new yt;for(let p=1;p<=e;++p)s.lineTo(i+p*o+(p-1)*a,0),s.moveTo(i+p*o+(p-1)*a,0),s.lineTo(i+p*o+(p-1)*a,r),s.arc(t,0,t,Math.PI,0,!0),s.moveTo(i+p*(o+a),0),s.lineTo(i+p*(o+a),0);s.lineTo(l,0),s.lineTo(l,d),s.lineTo(0,d),s.lineTo(0,0);const f=s.getPoints(),P=new xt(f),M={curveSegments:24,steps:50,depth:Ce,bevelEnabled:!1},C=new vt(P,M);return C.translate(-l/2,0,-Ce/2),C}function Eo(e=3,t=.15){const o=be-.25,r=e*o;let n=[],a,i,c;for(let d=0;d<e;++d){for(let s=0;s<4;++s){a=new G(t,t,o),i=a.clone();const f=Math.sqrt(2*o*o);c=new G(t,t,f),s%2==0?(a.rotateZ(Math.PI/2),a.translate(0,d*o,(-1)**(s>>1)*o/2),c.rotateZ((-1)**(s>>1)*Math.PI/4),c.translate(0,d*o+o/2,(-1)**(s>>1)*o/2),i.translate((-1)**(s>>1)*o/2,d*o+o/2,(-1)**(s&1)*o/2)):(a.rotateX(Math.PI/2),a.translate((-1)**(s>>1)*o/2,d*o,0),c.rotateX((-1)**(s>>1)*Math.PI/4),c.translate((-1)**(s>>1)*o/2,d*o+o/2,0),i.translate((-1)**(s>>1)*o/2,d*o+o/2,(-1)**(s&1)*o/2)),n.push(a),n.push(c),n.push(i)}if(d+1==e)for(let s=0;s<4;++s)a=new G(t,t,o),s%2==0?(a.rotateZ(Math.PI/2),a.translate(0,(d+1)*o,(-1)**(s>>1)*o/2)):(a.rotateX(Math.PI/2),a.translate((-1)**(s>>1)*o/2,(d+1)*o,0)),n.push(a)}const l=ge(n);return l.rotateZ(Math.PI/2),l.translate(r/2,o/2,0),l}function ht(e=1,t=3,o=0,r=0,n=10,a=0,i=1){const c=t*2,l=n,d=n,s=r+t+Ft,f=e*(o+c)+o+l+d,P=.3,M=new Mt,C=ft(e,t,o,r,n);C.translate(0,0,-be/2);const p=ft(e,t,o,r,n);p.translate(0,0,be/2);const k=ge([C,p]),g=new D(f,Me,be+Ce);g.translate(0,s+Me/2,0),I.ladrillos.object.wrapS=B,I.ladrillos.object.wrapT=B,I.ladrillos.object.repeat.set(.75*.15,.75*.35),I.ladrillos.object.anisotropy=16;const b=new S({side:A,transparent:!1,opacity:1,shininess:10,map:I.ladrillos.object}),E=new j(k,b);M.add(E);let z=g.attributes.uv.array;for(let N=0,Z=z.length;N<Z;N++)z[N]=N%2?z[N]*2.5:z[N]*30;const X=new j(g,b);M.add(X);const U=Eo(a);U.translate(0,s+Me-P*2,0);const H=new S({side:A,transparent:!1,opacity:1,shininess:10,color:16777215}),$=new j(U,H);M.add($);const R=new D(be+Ce+.01,f+.01,.1);R.rotateZ(Math.PI/2),R.rotateX(Math.PI/2),R.translate(0,s+Me,0),I.tierra.object.wrapS=at,I.tierra.object.wrapT=at,I.tierra.object.repeat.set(1,5),I.tierra.object.anisotropy=16;const ne=new S({side:A,transparent:!1,opacity:1,shininess:10,map:I.tierra.object}),ce=new j(R,ne);return M.add(ce),M}Go();const zo=""+new URL("sky_day_void-BqCvwB2K.jpg",import.meta.url).href,Ro=""+new URL("sky_night-DwhtyC8W.jpg",import.meta.url).href,Bo=""+new URL("elevation_map_wider_river-DnDx4q0m.png",import.meta.url).href,Uo=""+new URL("tree_forbidden_zone_map_wider_path-PXrrntcL.png",import.meta.url).href;let y,ie,Be,wt,Pe,re,he,T,je,L,Q,J,ee,F=[],Le=[],w={ambient:{object:null},directional:{object:null},hemisphere:{object:null}},x={animationEnable:!1,showTrain:!0,currCameraIndex:0,nightMode:!0,showHelpers:!1},Ue,Fe=!1,ae=!1,Se=!1,Te=!1,Ae=!1,gt=performance.now();const V=new m,pe=new m,Vo=150,_o=150,Ke=10,Ye=-2.1,h={skyDay:{url:zo,object:null},skyNight:{url:Ro,object:null},roca:{url:Je,object:null},pasto:{url:et,object:null},tierra:{url:Qe,object:null},madera:{url:eo,object:null},durmientes:{url:jt,object:null},elevationMap:{url:Bo,object:null},treeForbiddenMap:{url:Uo,object:null}};function Ie(){const e=window.innerWidth/window.innerHeight;for(let t=0;t<F.length;++t)F[t]!=null&&(F[t].aspect=e,F[t].updateProjectionMatrix());ie.setSize(window.innerWidth,window.innerHeight)}function Ho(){const e=F.length;F[x.currCameraIndex].name=="firstPersonCamera"&&(T.unlock(),oe.style.display="none",K.style.display="flex"),x.currCameraIndex==0?x.currCameraIndex=e-1:x.currCameraIndex-=1,F[x.currCameraIndex].name=="firstPersonCamera"&&(T.unlock(),oe.style.display="block",K.style.display="flex"),Ie()}function St(){const e=F.length;F[x.currCameraIndex].name=="firstPersonCamera"&&(T.unlock(),oe.style.display="none",K.style.display="flex"),x.currCameraIndex==e-1?x.currCameraIndex=0:x.currCameraIndex+=1,F[x.currCameraIndex].name=="firstPersonCamera"&&(T.unlock(),oe.style.display="block",K.style.display="flex"),Ie()}const oe=document.getElementById("blocker"),K=document.getElementById("instructions");function Ve(e){switch(e){case"click":console.log("click"),T.lock();break;case"lock":console.log("lock"),K.style.display="none",oe.style.display="none";break;case"unlock":console.log("unlock"),oe.style.display="block",K.style.display="flex";break}}function bt(e){if(e.type=="keydown"){switch(e.code){case"ArrowUp":case"KeyW":Fe=!0,e.shiftKey&&(ae=!0);break;case"ArrowLeft":case"KeyA":Te=!0;break;case"ArrowDown":case"KeyS":Se=!0;break;case"ArrowRight":case"KeyD":Ae=!0;break;case"KeyC":e.shiftKey?Ho():St();break;case"Space":console.log("Toggling train animations"),x.animationEnable=!x.animationEnable,he!=null&&he.__controllers[0].updateDisplay();break}switch(e.key){case"Shift":ae||(ae=!0);break}}else{switch(e.code){case"ArrowUp":case"KeyW":Fe=!1,ae=!1;break;case"ArrowLeft":case"KeyA":Te=!1;break;case"ArrowDown":case"KeyS":Se=!1;break;case"ArrowRight":case"KeyD":Ae=!1;break}switch(e.key){case"Shift":ae&&(ae=!1);break}}}function No(){const e=new le(50,window.innerWidth/window.innerHeight,.1,1e3);e.position.set(0,5,20),e.lookAt(-10,5,0),e.name="firstPersonCamera",F.push(e),T=new ro(e,document.body),K.addEventListener("click",function(){Ve("click")}),T.addEventListener("lock",function(){Ve("lock")}),T.addEventListener("unlock",function(){Ve("unlock")}),y.add(T.getObject()),window.addEventListener("keydown",t=>{bt(t)}),window.addEventListener("keyup",t=>{bt(t)})}function Wo(){y=new Et,ie=new zt,ie.setPixelRatio(window.devicePixelRatio),ie.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(ie.domElement);const e=new le(35,window.innerWidth/window.innerHeight,.1,1e3);e.position.set(-32,38,70),e.lookAt(0,0,0),e.name="topView",F.push(e),je=new Rt(e,ie.domElement),w.ambient.object=new Bt(16777215),w.hemisphere.object=new Ut(16777215,0,.25),w.directional.object=new Vt(16777215,1),w.directional.object.position.set(-100,100,100),y.add(w.ambient.object),y.add(w.hemisphere.object),y.add(w.directional.object),x.nightMode==!0?(w.ambient.object.visible=!1,w.hemisphere.object.intensity=0,w.directional.object.color.setHex(13491710),y.background=h.skyNight.object,w.directional.object.position.set(100,100,100)):(w.ambient.object.visible=!0,w.hemisphere.object.intensity=1,w.directional.object.intensity=1,w.directional.object.color.setHex(16777215),y.background=h.skyDay.object,w.directional.object.position.set(-100,100,100));const t=new _t(w.hemisphere.object,5);x.showHelpers&&y.add(t);const o=new Ht(w.directional.object,5);x.showHelpers&&y.add(o);const r=new Nt(200,200);x.showHelpers&&y.add(r);const n=new Wt(5);x.showHelpers&&y.add(n),window.addEventListener("resize",Ie),Ie(),h.skyDay.object.mapping=st,h.skyNight.object.mapping=st,x.nightMode==!0?y.background=h.skyNight.object:y.background=h.skyDay.object}function Xo(e,t){t.wrapS=t.wrapT=B,h[e].object=t,console.log("Texture `"+e+"` loaded")}function $o(e){const t=new ve;t.onLoad=()=>{console.log("All textures loaded"),e()};for(const o in h){console.log("Loading textures");const r=new we(t),n=h[o];n.object=r.load(n.url,Xo.bind(this,o),null,a=>{console.error(a)})}}function Zo(){const e=ht(1,3,0,0,10,2,2),t=ht(2,2,1,0,15,3,2);e.scale.set(.5,.5,.5),e.position.set(16,-.75,36),t.scale.set(.5,.5,.5),t.position.set(-14,-.25,-41);const o=new le(55,window.innerWidth/window.innerHeight,.1,1e4);o.position.set(-18,11,-2.75),o.lookAt(50,0,42),t.add(o),o.name="bridgeCamera",F.push(o),y.add(e),y.add(t),Le.push(e),Le.push(t)}function Oo(){L=Io();const e=new le(55,window.innerWidth/window.innerHeight,.1,1e4);e.position.set(0,7,-11),e.lookAt(0,20,100),L.add(e),e.name="trainConductorCamera",F.push(e);const t=new le(55,window.innerWidth/window.innerHeight,.1,1e4);t.position.set(-12,6,-20),t.lookAt(0,10,15),L.add(t),t.name="trainCamera",F.push(t);const o=new le(55,window.innerWidth/window.innerHeight,.1,1e4);o.position.set(0,16,-10),o.lookAt(0,18,-100),L.add(o),o.name="trainBackCamera",F.push(o),Q=new Ee(16777215,100,2e3,Math.PI/3,.5,.5),L.add(Q.target),L.add(Q),Q.position.set(0,2,15),Q.target.position.set(0,-100,100),Q.target.updateMatrixWorld(),J=new Ee(16777215,10,4,Math.PI/2,.5,.5),L.add(J.target),L.add(J),J.position.set(0,5,20),J.target.position.set(0,0,-100),J.target.updateMatrixWorld(),ee=new Ee(16777215,10,10,Math.PI/2,.5,.5),L.add(ee.target),L.add(ee),ee.position.set(0,5,10),ee.target.position.set(0,0,100),ee.target.updateMatrixWorld(),L.scale.set(.145,.145,.145),L.visible=x.showTrain,y.add(L)}function qo(){const e=ko();h.durmientes.object.wrapS=B,h.durmientes.object.wrapT=B,h.durmientes.object.repeat.set(1,150),h.durmientes.object.anisotropy=16;const t=new we().load("https://threejs.org/examples/textures/uv_grid_opengl.jpg");t.wrapS=t.wrapT=B,t.repeat.set(1,80),t.anisotropy=16;const o=new S({side:A,transparent:!1,opacity:1,shininess:10,map:h.durmientes.object}),r=new j(e,o);r.position.set(-1,1.25,-1),r.scale.set(1,1.5,1),y.add(r)}function Ko(){const e=Mo(),t=new S({side:A,transparent:!1,opacity:1,shininess:10,color:16777215}),o=new j(e,t);o.position.set(-1,1.25,-1),o.scale.set(1,1.5,1),y.add(o)}function Yo(){const e=new S({color:16777215,specular:3355443,shininess:10,side:A,reflectivity:1});let t={dirtSampler:{type:"t",value:h.tierra.object},rockSampler:{type:"t",value:h.roca.object},grassSampler:{type:"t",value:h.pasto.object},scale:{type:"f",value:3},terrainAmplitude:{type:"f",value:Ke},terrainAmplitudeBottom:{type:"f",value:Ye},worldNormalMatrix:{type:"m4",value:null},dirtStepWidth:{type:"f",value:.2},rockStepWidth:{type:"f",value:.15}};return e.defines={USE_UV:!0},e.onBeforeCompile=function(o){o.uniforms.dirtSampler=t.dirtSampler,o.uniforms.rockSampler=t.rockSampler,o.uniforms.grassSampler=t.grassSampler,o.uniforms.scale=t.scale,o.uniforms.terrainAmplitude=t.terrainAmplitude,o.uniforms.terrainAmplitudeBottom=t.terrainAmplitudeBottom,o.uniforms.worldNormalMatrix=t.worldNormalMatrix,o.uniforms.dirtStepWidth=t.dirtStepWidth,o.uniforms.rockStepWidth=t.rockStepWidth,o.vertexShader=o.vertexShader.replace("vViewPosition = - mvPosition.xyz;",`vViewPosition = - mvPosition.xyz;
			 vWorldPosition = (modelMatrix*vec4(transformed,1.0)).xyz;`),o.vertexShader=`varying vec3 vWorldPosition;
		`+o.vertexShader,o.fragmentShader=`
uniform float scale;
uniform float terrainAmplitude;
uniform float terrainAmplitudeBottom;
uniform float dirtStepWidth;
uniform float rockStepWidth;

uniform sampler2D dirtSampler;
uniform sampler2D rockSampler;
uniform sampler2D grassSampler;
varying vec3 vWorldPosition;

`+o.fragmentShader,o.fragmentShader=o.fragmentShader.replace("void main() {",`
float myNormalizeFunc(float inputValue, float minValue, float maxValue) {
	return (inputValue - minValue) / (maxValue - minValue);
}

void main () {
	float heightFactor = vWorldPosition.y - terrainAmplitudeBottom;
	float heightFactorNormalized = myNormalizeFunc(heightFactor, 0.0, terrainAmplitude);
`),o.fragmentShader=o.fragmentShader.replace("#include <map_fragment>",`// calculamos las coordenadas UV en base a las coordenadas de mundo
vec2 uvCoords=vWorldPosition.xz/100.0;
vec2 myUV  = uvCoords*8.0;
vec2 myUV2 = uvCoords*scale;

vec3 grass = texture2D(grassSampler, uvCoords).xyz;
vec3 dirt  = texture2D(dirtSampler, uvCoords*4.0).xyz;
vec3 rock  = texture2D(rockSampler, uvCoords).xyz;

// si quisieramos podriamos usar la variabl vUv tambien que son las coordenadas UV del vertice

// muestreo de pasto a diferentes escalas, luego se combina con \`mix()\`
vec3 grass1 = texture2D(grassSampler, myUV2*1.00).xyz;
vec3 grass2 = texture2D(grassSampler, myUV2*3.13).xyz;
vec3 grass3 = texture2D(grassSampler, myUV2*2.37).xyz;
vec3 colorGrass = mix(mix(grass1,grass2,0.5),grass3,0.3);

// lo mismo para la textura de tierra
vec3 dirt1 = texture2D(dirtSampler, myUV2*3.77).xyz;
vec3 dirt2 = texture2D(dirtSampler, myUV2*1.58).xyz;
vec3 dirt3 = texture2D(dirtSampler, myUV2*1.00).xyz;
vec3 colorDirt = mix(mix(dirt1, dirt2, 0.5), dirt3, 0.3);

// lo mismo para la textura de roca
vec3 rock1 = texture2D(rockSampler,myUV2*0.40).xyz;
vec3 rock2 = texture2D(rockSampler,myUV2*2.38).xyz;
vec3 rock3 = texture2D(rockSampler,myUV2*3.08).xyz;
vec3 colorRock = mix(mix(rock1, rock2, 0.5), rock3,0.5);

float u = heightFactorNormalized;

float width2 = rockStepWidth;
float rockFactor = 2.00 - smoothstep(0.0, width2, u) - smoothstep(1.0, 1.00 - width2, u);

float width = dirtStepWidth;
float s1 = smoothstep(0.00, width, u);
float s2 = smoothstep(width, width*2.0, u);
float s3 = smoothstep(0.50, 0.50 + width, u);
float s4 = smoothstep(0.50 + width, 0.50 + width*2.0, u);
float dirtFactor = (s1 - s2) + (s3 - s4);

float grassFactor = smoothstep(0.0, 0.35, u) - smoothstep(0.35, 1.00, u);

vec3 colorDirtGrass = mix(colorDirt, colorGrass, grassFactor);
vec3 colorDirtGrassDirt = mix(colorDirtGrass, colorDirt, dirtFactor);
vec3 color = mix(colorDirtGrassDirt, colorRock, rockFactor);

diffuseColor = vec4(color, 1.0);

// leemos los colores de las texturas
// vec4 grassColor = texture2D(grassSampler,uvCoords);
// vec4 rockColor = texture2D(rockSampler,uvCoords);

// mezclamos los colores en base a la altura del vertice
// diffuseColor = mix(grassColor, rockColor, smoothstep(0.0,5.0,vWorldPosition.y));`)},e}function Qo(){wt=go(100,100,Ke,Vo,_o,h.elevationMap.object),console.log("Applying textures"),Be=new Zt({uniforms:{dirtSampler:{type:"t",value:h.tierra.object},rockSampler:{type:"t",value:h.roca.object},grassSampler:{type:"t",value:h.pasto.object},scale:{type:"f",value:2.5},terrainAmplitude:{type:"f",value:Ke},terrainAmplitudeBottom:{type:"f",value:Ye},worldNormalMatrix:{type:"m4",value:null},dirtStepWidth:{type:"f",value:.2},rockStepWidth:{type:"f",value:.15}},vertexShader:qt,fragmentShader:Kt,side:A});const o=Yo();Pe=new j(wt,o),Be.onBeforeRender=(i,c,l,d,s)=>{let f=s.matrixWorld.clone();f=f.transpose().invert(),s.material.uniforms.worldNormalMatrix.value=f},Be.needsUpdate=!0,y.add(Pe),Pe.position.set(0,Ye,0),Le.push(Pe),console.log("Generating water");const r=new Ot(100/2,100-1.25),n=new S({color:1223679,side:A}),a=new j(r,n);a.rotateX(Math.PI/2),a.position.set(0,0,-.65),y.add(a)}function Jo(){const e=lo(24,12,.5,46);h.madera.object.wrapS=B,h.madera.object.wrapT=B,h.madera.object.repeat.set(.1,.1),h.madera.object.anisotropy=16;const t=new S({side:A,transparent:!1,opacity:1,shininess:10,map:h.madera.object}),o=new j(e,t);o.scale.set(.5,.5,.5);const r=$e(.32);o.position.set(r[0].x,0,r[0].z),o.lookAt(r[1].x*1e3,0,r[1].z*1e3),y.add(o);const n=new le(65,window.innerWidth/window.innerHeight,.1,1e4);n.position.set(-1,12,18),n.lookAt(0,10,-10),n.name="tunnelCamera",o.add(n),F.push(n)}function en(e=50){const[t,o]=po(e);y.add(t),y.add(o)}function tn(){console.log("Toggling night mode"),console.log(x.nightMode),x.nightMode==!0?(w.ambient.object.visible=!1,w.hemisphere.object.intensity=0,w.directional.object.color.setHex(13491710),y.background=h.skyNight.object,w.directional.object.position.set(100,100,100),Q.visible=!0,J.visible=!0,ee.visible=!0):(w.ambient.object.visible=!0,w.hemisphere.object.intensity=1,w.directional.object.intensity=1,w.directional.object.color.setHex(16777215),y.background=h.skyDay.object,w.directional.object.position.set(-100,100,100),Q.visible=!1,J.visible=!1,ee.visible=!1)}function on(){he=new Xt({width:250}),he.add(x,"animationEnable",!0).name("Animaciones"),he.add(x,"showTrain").name("Mostrar tren").onChange(function(){L.visible=!L.visible}),he.add(x,"nightMode",!1).name("Modo noche").onChange(tn)}function nn(){console.log("Building scene"),Jo(),en(350),Qo(),qo(),Ko(),Oo(),Zo()}function Tt(){let e=F[x.currCameraIndex];switch(e.name){case"topView":je.enabled=!0,oe.style.display="none",K.style.display="none";break;case"firstPersonCamera":je.enabled=!1;break;default:je.enabled=!1,oe.style.display="none",K.style.display="none";break}requestAnimationFrame(Tt),ie.render(y,e);const t=.001;if(x.animationEnable&&(re=re<1-t?re+t:0),L.visible){Lt(re*200),$e(re);const i=$e(re);let c=i[0].x,l=i[0].z;L.position.set(-1+c,2.3,-1+l),L.lookAt(i[1].x*1e3,1.9,i[1].z*1e3)}let o=performance.now();const r=1.6;if(T.isLocked===!0){Ue=new $t;var n=new m;n.copy(T.getObject().position),n.y+=2;var a=new m(0,-1,0);Ue.set(n,a);const i=Ue.intersectObjects(Le);let c;i==null||i[0]==null?c=0:c=i[0].point.y;const l=(o-gt)/1e3;V.x-=V.x*11*l,V.z-=V.z*11*l,V.y-=9.8*100*l,pe.z=Number(Fe)-Number(Se),pe.x=Number(Ae)-Number(Te),pe.normalize(),(Fe||Se)&&(ae?V.z-=pe.z*200*l:V.z-=pe.z*100*l),(Te||Ae)&&(V.x-=pe.x*100*l),T.moveRight(-V.x*l),T.moveForward(-V.z*l),T.getObject().position.y=c<0?r:c+r,T.getObject().position.y<c+r&&(V.y=0,T.getObject().position.y=r)}gt=o}function rn(){Wo(),No(),re=.9,nn(),on(),St(),Tt()}$o(rn);
